<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻譯</title>
    <style>
        /* 引入 LINE Seed TW 字型（Regular） */
        @font-face {
            font-family: 'LINESeedTW';
            src: url('./LINE Seed TW_ver02/TTF/LINESeedTW_TTF_Rg.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        /* 中文用 LINE Seed TW，英文和日文用微軟正黑體 */
        body {
            font-family: 'LINESeedTW', 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        /* 強制中文用 LINESeedTW */
        :lang(zh), :lang(zh-Hant), :lang(zh-TW) {
            font-family: 'LINESeedTW', 'Microsoft JhengHei', sans-serif;
        }
        /* 英文和日文用微軟正黑體 */
        :lang(en), :lang(ja) {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        /* 簡單的響應式 CSS，確保手機和電腦都可用 */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f4f4; }
        h1 { text-align: center; color: #333; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        textarea { width: 100%; height: 150px; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
        select { padding: 10px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #result-area { margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 4px; min-height: 50px; white-space: pre-wrap; }
        .controls { display: flex; align-items: center; margin-bottom: 20px; }
        .controls > * { margin-right: 10px; }
        #swap-btn { background-color: #6c757d; font-size: 1.2em; line-height: 1; padding: 5px 10px; }
        .language-group { flex-grow: 1; }
    </style>
</head>
<body>
    <h1>自用無廣告翻譯</h1>
    <div class="container">
        <div class="language-group">
            <label for="source-lang">來源語言:</label>
            <select id="source-lang">
                <option value="auto">自動偵測</option>
                <option value="zh-tw" selected>繁體中文</option>
                <option value="ja">日文</option>
                <option value="en">英文</option>
            </select>
        </div>
        <textarea id="input-text" placeholder="請輸入要翻譯的句子或短文..." oninput="autoTranslate()"></textarea>

        <div class="controls">
            <div class="language-group">
                <label for="target-lang">目標語言:</label>
                <select id="target-lang">
                    <option value="zh-tw">繁體中文</option>
                    <option value="ja" selected>日文</option>
                    <option value="en">英文</option>
                </select>
            </div>
            <button id="swap-btn" onclick="swapLanguages()">⇄</button>
            <button onclick="translateText()">手動翻譯</button>
        </div>

        <h2>翻譯結果:</h2>
        <div id="result-area"></div>
        <p id="status-message" style="color: red;"></p>
    </div>

    <script>
        // 步驟一：將您的所有 Apps Script API 網址放在這個陣列中
        const API_URLS = [
            //umiwued
            "https://script.google.com/macros/s/AKfycbxSUTL_ztpG9JY2bYyZFWvmuzY9Kf6fJneZi1ddsZBO4s7OP8AHvqfBAbLhqTgmN84/exec",
            
            //yunari202505
            "https://script.google.com/macros/s/AKfycbzl--LvEA8pWCvwV5oXShC6dsmW4L8MC4KvNm2xmpQlTagP1toabvWfrTizRuuIGHtg/exec",
            
            //lucienwucloud
            "https://script.google.com/macros/s/AKfycbwtnn2V-O8MkQ-qvwGBtUwSoQGgGyFkHKFAYgUQg1DTMSVHlj68BgmRl2QbEsTNAekc/exec",

            //lucienwuuu
            "https://script.google.com/macros/s/AKfycbzjefXUT5qEe5YvpKZ1Gu-FK4UXyjeGLFGUDED_Mrm0dXEeEyQZifNRBQknlcGhVBfk/exec",

            //lucienwooo
            "https://script.google.com/macros/s/AKfycbwgcGENGItJiZPKDnmDT4_C0J0duRElp4A82xOm0f1_gXT5gCQJcg6nJLwj_QGwNZcv/exec"
        ]; 
        
        // 用來追蹤目前使用到哪個 API 的索引
        let currentApiIndex = 0;

        let lastInput = "";
        let timer = null;

        function swapLanguages() {
            const source = document.getElementById('source-lang');
            const target = document.getElementById('target-lang');
            const tempTargetValue = target.value; 

            if (source.value !== 'auto') {
                target.value = source.value;
                source.value = tempTargetValue;
            } else {
                source.value = tempTargetValue;
                target.value = 'auto'; 
            }
            translateText();
        }

        function autoTranslate() {
            if (timer) {
                clearTimeout(timer);
            }
            timer = setTimeout(translateText, 500); 
        }

        function openGoogleTranslateFallback(text, sourceLang, targetLang) {
            const googleTranslateUrl = `https://translate.google.com/?sl=${sourceLang === 'auto' ? 'auto' : sourceLang}&tl=${targetLang}&text=${encodeURIComponent(text)}&op=translate`;
            window.open(googleTranslateUrl, '_blank');
        }
        
        async function translateText() {
            // 每次翻譯都先換下一個 API (確保負載均衡)
            currentApiIndex = (currentApiIndex + 1) % API_URLS.length;

            const text = document.getElementById('input-text').value.trim();
            const sourceLang = document.getElementById('source-lang').value;
            const targetLang = document.getElementById('target-lang').value;
            const resultArea = document.getElementById('result-area');
            const statusMessage = document.getElementById('status-message');

            if (text === "" || text === lastInput) {
                return;
            }
            lastInput = text;
            resultArea.innerText = "翻譯中...";
            statusMessage.innerText = "";
            
            let success = false;
            let attempts = 0;
            const maxAttempts = API_URLS.length;

            while (attempts < maxAttempts && !success) {
                const currentApiUrl = API_URLS[currentApiIndex];
                const url = `${currentApiUrl}?text=${encodeURIComponent(text)}&source=${sourceLang}&target=${targetLang}`;
                
                console.log(`嘗試使用 API 索引: ${currentApiIndex}`);
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.status === 'success') {
                        resultArea.innerText = data.translatedText;
                        statusMessage.innerText = `✅ 翻譯成功 (API 索引: ${currentApiIndex})`;
                        success = true;
                    } else if (data.status === 'limit_exceeded') {
                        resultArea.innerText = `⚠️ API ${currentApiIndex} 額度用盡，自動切換至下一個 API...`;
                        statusMessage.innerText = `錯誤: ${data.message}`;
                    } else {
                        resultArea.innerText = `❌ API ${currentApiIndex} 發生一般錯誤，嘗試下一個...`;
                        statusMessage.innerText = `錯誤: ${data.message}`;
                    }

                } catch (error) {
                    resultArea.innerText = `🌐 API ${currentApiIndex} 連線失敗，嘗試下一個...`;
                    statusMessage.innerText = `網路錯誤: ${error.message}`;
                }

                currentApiIndex = (currentApiIndex + 1) % API_URLS.length;
                attempts++;
            }
            
            if (!success) {
                resultArea.innerText = "❌ 免費額度已全部用盡或連線失敗！自動開啟 Google 翻譯備援。";
                statusMessage.innerText = "請在新視窗/標籤頁中查看翻譯結果。";
                openGoogleTranslateFallback(text, sourceLang, targetLang);
            }
        }

        window.onload = translateText; 
    </script>
</body>
</html>